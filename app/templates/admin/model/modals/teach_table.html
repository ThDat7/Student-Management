<table data-teach-id="{{ model.teach_id }}"
       class="teach-detail table table-striped table-bordered table-hover model-list">
    <thead>
    <tr>
        <th></th>
        <th>Họ</th>
        <th>Tên</th>
        <th>Điểm 15'</th>
        <th>Điểm 1 tiết</th>
        <th>Điểm thi</th>
    </tr>
    </thead>
    <tbody>
    {% for student in model.students %}
        <tr class="exam" data-exam-id="{{ student.exam.id }}" data-student-id="{{ student.id }}">
            <td>{{ loop.index }}</td>
            <td>{{ student.last_name }}</td>
            <td>{{ student.first_name }}</td>

            <td data-exam-type="normal">
                {% for d in student.exam.normal_exams %}
                    {% if d.factor.value == 1 %}
                        <button type="button" class="btn btn-secondary" data-toggle="modal"
                                data-target="#exam-modal"
                                data-id="{{ d.id }}">
                            {{ d.score }}
                        </button>
                    {% endif %}
                {% endfor %}

                <button type="button" class="btn btn-success add" data-toggle="modal"
                        data-target="#exam-modal"
                        data-factor="I">
                    Thêm
                </button>
            </td>
            <td data-exam-type="normal">
                {% for d in student.exam.normal_exams %}
                    {% if d.factor.value == 2 %}
                        <button type="button" class="btn btn-secondary" data-toggle="modal"
                                data-target="#exam-modal"
                                data-id="{{ d.id }}">
                            {{ d.score }}
                        </button>
                    {% endif %}
                {% endfor %}

                <button type="button" class="btn btn-success add" data-toggle="modal"
                        data-target="#exam-modal"
                        data-factor="II">
                    Thêm
                </button>
            </td>

            <td data-exam-type="final">
                <button style="width: 47px; height: 36px" type="button" class="btn btn-secondary" data-toggle="modal"
                        data-target="#exam-modal">
                    {% if student.exam is not none and student.exam.final_exam is not none %} {{ student.exam.final_exam.score }} {% endif %}
                </button>
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<div class="modal fade" id="exam-modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
            </div>
            <div class="modal-body">
                <input type="number" step="0.01"/>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary submit">Save changes</button>
                <button type="button" style="display: none" class="btn btn-danger delete">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
    $('#exam-modal').on('show.bs.modal', function (event) {
        const button = $(event.relatedTarget)
        let exam_id = button.closest('.exam').data('exam-id')
        const modal = $(this)

        const id = button.data('id')
        let score = parseFloat(button.text())

        const submitBtn = modal.find('.modal-footer button.submit')
        const deleteBtn = modal.find('.modal-footer button.delete')

        submitBtn.off("click")
        deleteBtn.off("click")
        modal.find('.modal-body input').val('')

        if (button.parent().data('exam-type') == 'normal') {
            if (id) {
                modal.find('.modal-body input').val(score)
                deleteBtn.css('display', 'block')
                submitBtn.on('click', ajaxUpdateNormalExam)
                deleteBtn.on('click', ajaxDeleteNormalExam)
            } else {
                deleteBtn.css('display', 'none')
                submitBtn.on('click', ajaxCreateNormalExam)
            }
        } else if (button.parent().data('exam-type') == 'final') {
            if (score)
                modal.find('.modal-body input').val(score)

            deleteBtn.css('display', 'none')
            submitBtn.on('click', ajaxUpdateFinalExam)
        }

        function ajaxSuccess(data, method) {
            modal.modal('toggle')

            if (method == 'CREATE') {
                button.before(`<button type="button" class="btn btn-secondary" data-toggle="modal"
                                data-target="#exam-modal"
                                data-id="${data.id}"
                                data-score="${data.score}">
                            ${Number.isInteger(data.score) ? data.score.toFixed(1) : data.score}
                        </button>`)
            }

            if (method == 'UPDATE') {
                button.html(Number.isInteger(data.score) ? data.score.toFixed(1) : data.score)
                button.data('score', data.score)
            }

            if (method == 'DELETE') {
                button.remove()
            }

        }

        async function ajaxCreateExam() {
            const teach_id = $('table.teach-detail').data('teach-id')
            const student_id = button.closest('.exam').data('student-id')

            await $.ajax({
                type: 'POST',
                url: `/api/exam`,
                data: JSON.stringify({
                    'student_id': student_id,
                    'teach_id': teach_id
                }),
                contentType: "application/json; charset=utf-8",
                traditional: true,
                success: (data) => {
                    exam_id = data.id
                    button.closest('.exam').data('exam-id', data.id)
                }
            })
        }

        async function ajaxUpdateFinalExam() {
            if (exam_id == '')
                await ajaxCreateExam()

            score = modal.find('.modal-body input').val()
            $.ajax({
                type: 'POST',
                url: `/api/final_exam/${exam_id}`,
                data: JSON.stringify({
                    'score': score
                }),
                contentType: "application/json; charset=utf-8",
                traditional: true,
                success: (data) => {
                    ajaxSuccess(data, 'UPDATE')
                }
            })
        }

        async function ajaxCreateNormalExam() {
            if (exam_id == '')
                await ajaxCreateExam()

            score = modal.find('.modal-body input').val()
            const factor = button.data('factor');
            $.ajax({
                type: 'POST',
                url: `/api/normal_exam`,
                data: JSON.stringify({
                    'exam_id': exam_id,
                    'factor': factor,
                    'score': score
                }),
                contentType: "application/json; charset=utf-8",
                traditional: true,
                success: (data) => {
                    ajaxSuccess(data, 'CREATE')
                }
            })

        }

        function ajaxUpdateNormalExam() {
            score = modal.find('.modal-body input').val()
            $.ajax({
                type: 'PUT',
                url: `/api/normal_exam/${id}`,
                data: JSON.stringify({
                    'exam_id': exam_id,
                    'score': score
                }),
                contentType: "application/json; charset=utf-8",
                traditional: true,
                success: (data) => {
                    ajaxSuccess(data, 'UPDATE')
                }
            })
        }

        function ajaxDeleteNormalExam() {
            $.ajax({
                type: 'DELETE',
                url: `/api/normal_exam/${id}`,
                data: JSON.stringify({
                    'exam_id': exam_id
                }),
                contentType: "application/json; charset=utf-8",
                traditional: true,
                success: (data) => {
                    ajaxSuccess(data, 'DELETE')
                }
            })
        }
    })
</script>